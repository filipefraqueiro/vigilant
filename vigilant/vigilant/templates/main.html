<!DOCTYPE html>
<html>

<head>
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
</head>

<body>

    <div class="form-group">
        <label for="role">Connection</label>
        <select class="form-control" id="connection" name="connection" onchange="get_connection(this)">
            <option value="0" selected>Select a Connection</option>
            {% for connection in connections %}
            <option value="{{ connection.id }}">{{ connection }}</option>
            {% endfor %}
        </select>
    </div>

    <table class="table" id="data-table">
        <thead></thead>
        <tbody></tbody>
    </table>

    <script>
        function titleCase(s) {
            return s.toLowerCase()
                .split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }

        async function get_connection(e) {
            request(e.value);
            // clearInterval(myInterval);
            // const milliseconds = 5000;
            // myInterval = setInterval(request, milliseconds, e.value);
        }
        
        async function request(id) {
            const url = "/connection?id=" + id;

            try {
                const response = await fetch(url, {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json"
                    },
                });

                if (!response.ok) {
                    throw new Error(`Response status: ${response.status}`);
                }

                const result = await response.json();
                // console.log(result);
                createTableFromJSON(result, "data-table");

            } catch (error) {
                console.error(error.message);
            }
        }


        function createTableFromJSON(data, tableId) {
            const table = document.getElementById(tableId);
            const thead = table.querySelector("thead");
            const tbody = table.querySelector("tbody");

            // Clear existing content
            thead.innerHTML = "";
            tbody.innerHTML = "";

            // Create header
            const headerRow = document.createElement("tr");
            data["fields"].forEach(col => {
                const th = document.createElement("th");
                th.textContent = titleCase(col.replaceAll("_", " "));
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);

            // Create rows
            data["entries"].forEach(row => {
                const tr = document.createElement("tr");

                for (const [key, value] of Object.entries(row)) {
                    const td = document.createElement("td");

                    // Render objects as JSON
                    td.textContent =
                        typeof value === "object" && value !== null
                            ? JSON.stringify(value)
                            : value ?? "";

                    tr.appendChild(td);
                };

                tbody.appendChild(tr);
            });
        }
    </script>
</body>

</html>